<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TT tool</title>
    <link rel="stylesheet" href="QueryCreator.css">
</head>

<body>
    <div id="sidebar" class="collapsed">
        <div id="sidebarTop" onclick="toggleSidebar()">
            <span class="brand">
                <span id="sidebarInitial">M</span>
                <!-- Иконка для ховера по M в свернутом состоянии -->
                <img id="menuIconHover" src="menu_icon.png" alt="menu" />
            </span>

            <span id="sidebarTitle">Moon Active</span>
            <!-- Иконка справа в открытом состоянии -->
            <img id="sidebarMenuRight" src="menu_icon.png" alt="menu" />
        </div>

        <nav class="tabs">
            <div class="tab active" onclick="switchTab('tab1')">
                <img class="icon" src="icon_1.png" alt="">
                <span class="label">Query Creator</span>
            </div>
            <div class="tab" onclick="switchTab('tab2')">
                <img class="icon" src="icon_2.png" alt="">
                <span class="label">Tab 2</span>
            </div>
            <div class="tab" onclick="switchTab('tab3')">
                <img class="icon" src="icon_3.png" alt="">
                <span class="label">Tab 3</span>
            </div>
            <div class="tab" onclick="switchTab('tab4')">
                <img class="icon" src="icon_4.png" alt="">
                <span class="label">Tab 4</span>
            </div>
        </nav>
        <!-- ▼ Заменить весь старый блок футера на этот -->
        <div id="sidebarFooter">
            <button id="themeSlider" class="is-night" aria-label="Theme toggle">
                <span class="knob" aria-hidden="true"></span>

                <!-- Иконки внутри слайдера -->
                <img src="day.png" class="ico day" alt="">
                <img src="night.png" class="ico night" alt="">

                <!-- «Хит-зоны» для ховеров подсказок -->
                <span class="hit hit-left" aria-hidden="true"></span>
                <span class="hit hit-right" aria-hidden="true"></span>

                <!-- Тултипы -->
                <span class="tip tip-left">Light Mode</span>
                <span class="tip tip-right">Night Mode</span>
            </button>
        </div>


    </div>



    <!-- TAB 1 -->
    <div id="tab1View">

        <!-- НОВАЯ шапка — теперь видна только в tab1 -->
        <header class="container qc-header">
            <h1 class="qc-title">Query Creator</h1>
            <p class="muted qc-subtitle">
                A focused tool that converts analytics requirement spreadsheets into ready-to-use SQL queries </p>
        </header>

        <!-- Кнопка HowTo и тултип (вне секций, сразу под шапкой) -->
        <div class="container howto-wrap">
            <button id="howtoBtn" class="btn-refresh" type="button">How it works?</button>

            <!-- Пустой тултип 400×400 с закруглениями -->
            <div id="howtoTooltip" class="howto-tooltip card" role="dialog" aria-modal="false"
                aria-labelledby="howtoBtn">
                <div class="howto-tooltip__body">
                    <h3>How it works:</h3>
                    <ol>
                        <li><strong>Choose one of the data sources</strong>:
                            <ol class="howto-sublist" type="A">
                                <li><em>Paste columns: Event + Property</em> - paste the two columns separately</li>
                                <li class="with-img">
                                    <em>Upload TSV/TLS file</em> - in Google Sheets: <em>File → Download → Tab-separated
                                        values (.tsv)</em>, then upload the file:<br>

                                    <div class="howto-img-wrap">
                                        <img src="tsv_tab.jpg" alt="Save as TSV in Google Sheets" class="howto-img">
                                        <span class="zoom-badge" aria-hidden="true"></span>
                                    </div>
                                </li>
                                <li><em>Paste spreadsheet (clipboard)</em> - copy the whole table and paste it into the
                                    input</li>
                            </ol>
                        </li>

                        <li><strong>Pick a table</strong> in the <em>Table</em> field:
                            <code>Stage/RC</code> or <code>Production</code>.
                            <em>Optional:</em> set a date or a date range in the <strong>Date</strong> field
                        </li>

                        <li><strong>Table decompose</strong> - parse the data and tick the events you need</li>

                        <li><strong>SQL generating</strong> - get the combined query</li>

                        <li><strong>Export</strong>:
                            use <em>Copy to clipboard</em> or <em>Download .txt</em>.
                            If you selected multiple events, click <em>Generate per-event queries</em> -
                            each event will get its own query.
                            You can also download all of them at once with
                            <em>Download all .txt</em>
                        </li>
                    </ol>
                </div>

            </div>

        </div>

        <!---------my code---------->
        <main class="container grid">
            <section class="card">
                <h2>1. Analytics table input</h2>

                <label class="label step-label">1.1 Select a type of input</label>
                <!---------New field start---------->

                <!-- ▼ Выбор режима ввода -->
                <div class="input-modes">
                    <label class="mode-item">
                        <input type="radio" name="inputMode" id="modeSeparate" checked>
                        <span>Paste columns: Event + Property</span>
                    </label>
                    <label class="mode-item">
                        <input type="radio" name="inputMode" id="modeFile">
                        <span>Upload TSV/TLS file</span>
                    </label>
                    <label class="mode-item">
                        <input type="radio" name="inputMode" id="modePaste">
                        <span>Paste spreadsheet (TSV from clipboard)</span>
                    </label>
                </div>

                <!-- ▼ Режим 1: отдельные столбцы -->
                <div id="mode-separate" class="input-mode active">
                    <div class="input-section">
                        <label for="eventsInput">Events (paste the "Event" column)</label>
                        <textarea id="eventsInput" class="no-scroll" placeholder="Paste Event column here"></textarea>
                    </div>

                    <div class="input-section">
                        <label for="propertiesInput">Properties (paste the "Property" column)</label>
                        <textarea id="propertiesInput" class="no-scroll"
                            placeholder="Paste Property column here"></textarea>
                    </div>
                </div>

                <!-- ▼ Режим 2: загрузка файла -->
                <div id="mode-file" class="input-mode">
                    <div class="input-section">
                        <label class="label">Upload TSV/TLS file</label>
                        <input type="file" id="tlsFile" accept=".tsv,.txt,.csv" />
                    </div>
                </div>

                <!-- ▼ Режим 3: вставка полной таблицы -->
                <div id="mode-paste" class="input-mode">
                    <label class="label">Data from the Google Sheets with analytics requirements</label>
                    <textarea id="pasteArea"
                        placeholder="Paste the rows here (usually TSV from Google Sheets)"></textarea>
                </div>


                <!---------New field end---------->
                <label class="label step-label">1.2 Select a BQ Table and Generation mode</label>

                <div class="row">
                    <div class="field">
                        <div class="field">
                            <label class="label">Table</label>
                            <select id="tableEnv">
                                <option value="stage">Stage / RC (od-rc)</option>
                                <option value="prod">Production</option>
                            </select>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label">Generation mode</label>
                        <select id="mode">
                            <option value="property_in">SELECT event ...</option>
                            <option value="distinct_props">SELECT DISTINCT event ...</option>
                        </select>
                    </div>
                </div>

                <label class="label step-label">1.3 Select a date (optional, default is today)</label>

                <!-- ↓↓↓ Новый блок Дата ↓↓↓ -->
                <div class="row" id="dateRow">
                    <div class="field">
                        <div class="date-col">
                            <!-- Линия 1: Сегодня -->
                            <label class="date-option">
                                <input type="radio" name="dateMode" id="dateModeToday" checked>
                                Today <span id="todayText" class="chip-date"></span>
                            </label>


                            <!-- Линия 2: Диапазон + поля дат в своей строке -->
                            <div class="date-option">
                                <label class="inline">
                                    <input type="radio" name="dateMode" id="dateModeRange">
                                    Range
                                </label>

                                <div class="date-range" id="dateRangeWrap" style="display:none;">
                                    <input type="text" id="dateStart" class="date-input" inputmode="none" readonly
                                        style="max-width:180px;">
                                    <input type="text" id="dateEnd" class="date-input" inputmode="none" readonly
                                        style="max-width:180px;">
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

                <!-- ↑↑↑ Новый блок Дата ↑↑↑ -->


                <div class="row">
                    <button id="parseBtn" class="btn-primary">Table decompose</button>
                    <button id="refreshBtn" class="btn-refresh">Refresh</button>
                </div>
                <div id="errorBox" class="hidden"></div>
                <div id="infoBox" class="hidden"></div>
                <span id="parseStatus" class="muted small"></span>

                <div id="eventPicker" class="row" style="display:none;">
                    <div class="field">
                        <label class="label">Events</label>

                        <!-- Новый список чекбоксов -->
                        <div id="eventList" class="event-list" role="group" aria-label="Events list"></div>

                        <!-- Кнопки выбора -->
                        <div class="row" style="margin-top:8px;">
                            <button id="selectAllBtn" class="btn-refresh" type="button">Select all</button>
                            <button id="clearAllBtn" class="btn-refresh" type="button">Clear</button>
                        </div>
                    </div>

                    <button id="genBtn" class="btn-primary btn-full">SQL generating</button>
                </div>

            </section>

            <section class="card">
                <h2>2. Generated query</h2>
                <label class="label">SQL query</label>
                <textarea id="sqlOutput" readonly placeholder="SQL will appear here"></textarea>
                <div class="row row-copy">
                    <button id="copyBtn" class="btn-primary">Copy to clipboard</button>
                    <button id="downloadBtn" class="btn-refresh hidden" type="button">
                        Download .txt
                    </button>
                    <button id="clearBtn" class="btn-refresh">Clear SQL query field
                    </button>

                    <span id="copyStatus" class="copy-status" aria-live="polite" role="status"></span>
                </div>

                <!-- Кнопка «пер-ивентной» генерации (показываем только когда выбрано ≥2 событий) -->
                <div id="perEventControls" class="row" style="margin-top:10px; display:none;">
                    <button id="perEventBtn" class="btn-refresh" type="button">
                        Generate per-event queries
                    </button>
                </div>

                <!-- Контейнер, куда будут рендериться пер-ивентные SQL -->
                <div id="perEventContainer" style="display:none;"></div>

                <!-- Download all per-event queries -->
                <div id="perEventAllWrap" class="row" style="display:none;">
                    <button id="downloadAllPerBtn" class="btn-refresh" type="button">Download all .txt</button>
                </div>

            </section>
        </main>
    </div>
    <!---------my code---------->
    </div>


    <!-- TAB 2 -->
    <div id="tab2View" class="hidden">
        <main class="container grid">
            <section class="card">
                <h2>Second Tab Content</h2>
                <p>Another interface will go here.</p>
            </section>
        </main>
    </div>

    <!-- TAB 3 -->
    <div id="tab3View" class="hidden">
        <main class="container grid">
            <section class="card">
                <h2>Third Tab Content</h2>
                <p>Something else here.</p>
            </section>
        </main>
    </div>

    <!-- TAB 4 -->
    <div id="tab4View" class="hidden">
        <main class="container grid">
            <section class="card">
                <h2>Fourth Tab Content</h2>
                <p>More functionality here.</p>
            </section>
        </main>
    </div>


    <!-- FOOTER -->
    <footer class="container muted small">v.1.16 - 2025</footer>
    <script src="QueryCreator.js"></script>
</body>

</html>