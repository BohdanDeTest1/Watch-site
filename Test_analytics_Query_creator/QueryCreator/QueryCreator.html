<section id="qc-root">
    <!-- TAB 1 -->
    <div id="tab1View">

        <!-- НОВАЯ шапка — теперь видна только в tab1 -->
        <header class="container qc-header">
            <h1 class="qc-title">Query Creator</h1>
            <p class="muted qc-subtitle">
                A focused tool that converts analytics requirement spreadsheets into ready-to-use SQL queries </p>
        </header>

        <!-- Кнопка HowTo и тултип (вне секций, сразу под шапкой) -->
        <div class="container howto-wrap">
            <button id="howtoBtn" class="btn-refresh" type="button">How it works?</button>

            <!-- Пустой тултип 400×400 с закруглениями -->
            <div id="howtoTooltip" class="howto-tooltip card" role="dialog" aria-modal="false"
                aria-labelledby="howtoBtn">
                <div class="howto-tooltip__body">
                    <h3>How it works:</h3>
                    <ol>
                        <li><strong>Choose one of the data sources</strong>:
                            <ol class="howto-sublist" type="A">
                                <li class="with-img">
                                    <em>Upload TSV/TLS file</em> - in Google Sheets: <em>File → Download →
                                        Tab-separated
                                        values (.tsv)</em>, then upload the file:<br>


                                    <div class="howto-img-wrap">
                                        <img src="tsv_tab.jpg" alt="Save as TSV in Google Sheets" class="howto-img">
                                        <span class="zoom-badge" aria-hidden="true"></span>
                                    </div>

                                    <span class="small muted">
                                        <br> <br> If the tool can't detect the Event/Property columns,
                                        please manualy confirm which column names
                                        should be used.
                                    </span><br>
                                    <div class="howto-img-wrap">
                                        <img src="tsv_tab3.jpg" alt="Save as TSV in Google Sheets" class="howto-img">
                                        <span class="zoom-badge" aria-hidden="true"></span>
                                    </div>

                                </li>
                                <li><em>Paste columns: Event + Property</em> - paste the two columns separately</li>
                                <li><em>Paste spreadsheet (clipboard)</em> - copy the whole table and paste it into
                                    the
                                    input</li>
                            </ol>
                        </li>

                        <li><strong>Pick a table</strong> in the <em>Table</em> field:
                            <strong>'Stage/RC'</strong>, <strong>'Prod-cheats'</strong> or
                            <strong>'Production'</strong>.
                            <em>Optional:</em> set a date or a date range in the <strong>Date</strong> field
                        </li>

                        <li><strong>Table decompose</strong> - parse the data and tick the events you need</li>

                        <li><strong>SQL generating</strong> - get the combined query</li>

                        <li><strong>Export</strong>:
                            use <em>Copy to clipboard</em> or <em>Download .txt/.csv (Testomat)</em>.
                            If you selected multiple events, click <em>Generate per-event queries</em> -
                            each event will get its own query.
                            You can also download all of them at once with
                            <em>Download All</em>
                        </li>

                        <li class="with-img">
                            <strong>.CSV (Testomat)</strong>:
                            simply upload the exported .CSV file into Testomat — your queries will appear as test cases
                            in the new
                            Test Suite
                            <div class="howto-img-wrap">
                                <img src="Testomat.png" alt="Import CSV into Testomat"
                                    class="howto-img howto-img--testomat" data-zoom="half">
                                <span class="zoom-badge" aria-hidden="true"></span>
                            </div>
                        </li>
                        </li>
                    </ol>
                </div>

            </div>

            <div id="howtoBackdrop" class="howto-backdrop" hidden></div>

        </div>

        <!---------my code---------->
        <main class="container grid">
            <section class="card">
                <h2>1. Analytics table input</h2>

                <label class="label step-label">1.1 Select a type of input</label>
                <!---------New field start---------->

                <!-- ▼ Выбор режима ввода -->
                <div class="input-modes">
                    <label class="mode-item">
                        <input type="radio" name="inputMode" id="modeFile" checked>
                        <span>Upload TSV/TLS file</span>
                    </label>
                    <label class="mode-item">
                        <input type="radio" name="inputMode" id="modeSeparate">
                        <span>Paste columns: Event + Property</span>
                    </label>
                    <label class="mode-item">
                        <input type="radio" name="inputMode" id="modePaste">
                        <span>Paste spreadsheet (TSV from clipboard)</span>
                    </label>
                </div>

                <!-- ▼ Режим 1: загрузка файла -->
                <div id="mode-file" class="input-mode active">
                    <div class="input-section">
                        <div class="label-row">
                            <label class="label">Upload TSV/TLS file</label>
                            <button type="button" id="modeFileInfo" class="info-dot-upload"
                                aria-label="How to: Upload TSV/TLS file" title="How to: Upload TSV/TLS file">i</button>
                        </div>
                        <!-- переключатель: 1 table / 2 tables -->
                        <div class="row" style="margin-top:8px;">
                            <label class="mode-item">
                                <input type="radio" name="fileCount" id="oneTable" checked>
                                <span>1 table</span>
                            </label>
                            <label class="mode-item" style="margin-left:14px;">
                                <input type="radio" name="fileCount" id="twoTables">
                                <span>2 tables</span>
                            </label>
                        </div>

                        <!-- файл A + его Event source -->
                        <div class="file-block" id="fileBlockA" style="margin-top:10px;">
                            <h4 class="label table-label" id="tableLabelA" style="margin-bottom:6px;">Table №1</h4>
                            <input type="file" id="tlsFileA" accept=".tsv,.txt,.csv" />
                            <label class="label" style="margin-top:8px;">Event source</label>
                            <select id="eventSourceA">
                                <option value="none" selected>None</option>
                                <option value="server">Server</option>
                                <option value="client">Client</option>
                            </select>
                        </div>

                        <!-- файл B + его Event source (по умолчанию скрыт) -->
                        <div class="file-block hidden" id="fileBlockB" style="margin-top:14px;">
                            <h4 class="label table-label" id="tableLabelB" style="margin-bottom:6px;">Table №2</h4>
                            <input type="file" id="tlsFileB" accept=".tsv,.txt,.csv" />
                            <label class="label" style="margin-top:8px;">Event source</label>
                            <select id="eventSourceB">
                                <option value="none" selected>None</option>
                                <option value="server">Server</option>
                                <option value="client">Client</option>
                            </select>
                        </div>
                    </div>
                </div>


                <!-- ▼ Режим 2: отдельные столбцы -->
                <div id="mode-separate" class="input-mode ">
                    <div class="input-section">
                        <label for="eventsInput">Events (paste the "Event" column)</label>
                        <textarea id="eventsInput" class="no-scroll" placeholder="Paste Event column here"></textarea>
                    </div>

                    <div class="input-section">
                        <label for="propertiesInput">Properties (paste the "Property" column)</label>
                        <textarea id="propertiesInput" class="no-scroll"
                            placeholder="Paste Property column here"></textarea>
                    </div>

                    <div class="input-section">
                        <label class="label">Event source</label>
                        <select class="eventSource" id="eventSourceSeparate">
                            <option value="none" selected>None</option>
                            <option value="client">Client</option>
                            <option value="server">Server</option>
                        </select>
                    </div>

                </div>

                <!-- ▼ Режим 3: вставка полной таблицы -->
                <div id="mode-paste" class="input-mode">
                    <label class="label">Data from the Google Sheets with analytics requirements</label>


                    <textarea id="pasteArea"
                        placeholder="Paste the rows here (usually TSV from Google Sheets)"></textarea>
                    <div class="row" style="margin:8px 0;">
                        <div class="field">
                            <label class="label">Event source</label>
                            <select class="eventSource" id="eventSourcePaste">
                                <option value="none" selected>None</option>
                                <option value="client">Client</option>
                                <option value="server">Server</option>
                            </select>
                        </div>
                    </div>
                </div>


                <!---------New field end---------->
                <label class="label step-label">1.2 Select a BQ Table</label>

                <div class="row">
                    <div class="field">
                        <div class="field">
                            <label class="label">Table</label>
                            <select id="tableEnv" class="bq-table-select">
                                <option value="stage">Stage / RC (od-rc)</option>
                                <option value="prod-cheats">Prod-cheats</option>
                                <option value="prod">Production</option>
                            </select>
                        </div>
                    </div>
                </div>



                <label class="label step-label">1.3 Select a date (optional, default is today)</label>

                <!-- ↓↓↓ Новый блок Дата ↓↓↓ -->
                <div class="row" id="dateRow">
                    <div class="field">
                        <div class="date-col">
                            <!-- Линия 1: Сегодня -->
                            <label class="date-option">
                                <input type="radio" name="dateMode" id="dateModeToday" checked>
                                Today <span id="todayText" class="chip-date"></span>
                            </label>


                            <!-- Линия 2: Диапазон + поля дат в своей строке -->
                            <div class="date-option">
                                <label class="inline">
                                    <input type="radio" name="dateMode" id="dateModeRange">
                                    Range
                                </label>

                                <div class="date-range" id="dateRangeWrap" style="display:none;">
                                    <input type="text" id="dateStart" class="date-input" inputmode="none" readonly
                                        style="max-width:180px;">
                                    <input type="text" id="dateEnd" class="date-input" inputmode="none" readonly
                                        style="max-width:180px;">
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

                <!-- ↑↑↑ Новый блок Дата ↑↑↑ -->


                <div class="row">
                    <button id="parseBtn" class="btn-primary">Table decompose</button>
                    <button id="refreshPageBtn" class="btn-refresh">Refresh</button>
                </div>
                <div id="errorBox" class="hidden"></div>
                <div id="infoBox" class="hidden"></div>
                <span id="parseStatus" class="muted small"></span>

                <div id="eventPicker" class="row" style="display:none;">
                    <div class="field">


                        <div id="eventsClientWrap">
                            <h4 class="label" style="margin:8px 0 6px;">Client events</h4>
                            <div id="eventListClient" class="event-list" role="group" aria-label="Client events"></div>
                            <div class="row event-actions">
                                <button type="button" class="btn btn-small select-clear" data-action="select-all">Select
                                    all</button>
                                <button type="button" class="btn btn-small btn-secondary select-clear"
                                    data-action="clear">Clear</button>
                            </div>
                        </div>

                        <div id="eventsServerWrap" style="margin-top:0px;">
                            <h4 class="label" style="margin:8px 0 6px;">Server events</h4>
                            <div id="eventListServer" class="event-list" role="group" aria-label="Server events"></div>
                            <div class="row event-actions">
                                <button type="button" class="btn btn-small select-clear" data-action="select-all">Select
                                    all</button>
                                <button type="button" class="btn btn-small btn-secondary select-clear"
                                    data-action="clear">Clear</button>
                            </div>
                        </div>

                        <!-- NEW: None/Unknown source events -->
                        <div id="eventsNoneWrap" style="margin-top:0px; display:none;">
                            <h4 class="label" style="margin:8px 0 6px;">Event source: None</h4>
                            <div id="eventListNone" class="event-list" role="group" aria-label="None events"></div>
                            <div class="row event-actions">
                                <button type="button" class="btn btn-small select-clear" data-action="select-all">Select
                                    all</button>
                                <button type="button" class="btn btn-small btn-secondary select-clear"
                                    data-action="clear">Clear</button>
                            </div>
                        </div>
                    </div>

                    <!-- Кнопка + сообщение об ошибке под ней (в одной колонке) -->
                    <div id="genCol" class="gen-col">
                        <button id="genBtn" class="btn-primary btn-full">SQL generating</button>
                        <div id="genError" class="field-error hidden" aria-live="polite">
                            Please select at least one event
                        </div>
                    </div>


                </div>

            </section>

            <section class="card">
                <h2>2. Generated query</h2>
                <label class="label">SQL query</label>
                <textarea id="sqlOutput" readonly placeholder="SQL will appear here"></textarea>
                <!-- TOP grid (верхний ряд 2×1) -->


                <div id="topBtnGrid" class="btn-grid-2">
                    <button id="copyBtn" class="btn-primary">Copy to clipboard</button>

                    <!-- NEW: комбинированная кнопка Download -->
                    <div id="downloadCombo" class="dropdown hidden">
                        <button id="downloadComboBtn" class="btn-primary">Download ▾</button>
                        <div id="downloadMenu" class="dropdown-menu" aria-hidden="true">
                            <button id="downloadTxtTop" class="menu-btn txt">.txt</button>
                            <button id="downloadCsvTop" class="menu-btn csv">.csv (Testomat)</button>
                        </div>
                    </div>
                    <!--  <button id="clearBtn" class="btn-muted">Clear query</button> -->

                </div>

                <!--    <div id="perEventControls" class="row" style="margin-top:10px; display:none;">
                    <button id="perEventBtn" class="btn-refresh" type="button">
                        Generate per-event queries
                    </button>
                </div>-->

                <!-- слот для верхней кнопки Clear -->
                <div id="clearTopSlot">
                    <button id="clearBtn" class="btn-refresh clear-top">Clear query</button>
                </div>


                <!-- UNDER-TOP grid (нижний ряд 2×1) — скрыт по умолчанию; включаем в S1/S2 -->
                <div id="underTopGrid" class="btn-grid-2 hidden">
                    <div><!-- пусто, CSV больше нет --></div>
                    <div id="refreshSlot"></div>
                </div>


                <!-- статус копирования оставляем под всей зоной -->
                <span id="copyStatus" class="copy-status" aria-live="polite" role="status"></span>


                <!-- Кнопка «пер-ивентной» генерации (показываем только когда выбрано ≥2 событий) -->
                <div id="perEventControls" class="row" style="margin-top:10px; display:none;">
                    <button id="perEventBtn" class="btn-refresh" type="button">
                        Generate per- event queries
                    </button>
                </div>
                <div id="clearBottom" class="row" style="display:none;"></div>
                <div id="clearUnderPer" class="row" style="display:none;"></div>
                <!-- Контейнер, куда будут рендериться пер-ивентные SQL -->
                <div id="perEventContainer" style="display:none;"></div>

                <!-- Download all per-event queries -->
                <div id="perEventAllWrap" class="btn-grid-2 hidden">
                    <!-- NEW: Download All на всю ширину -->
                    <div id="downloadAllWrap" class="grid-span-2">
                        <div id="downloadAllCombo" class="dropdown">
                            <button id="downloadAllComboBtn" class="btn-primary">Download All ▾</button>
                            <div id="downloadAllMenu" class="dropdown-menu" aria-hidden="true">
                                <button id="downloadAllTxt" class="menu-btn txt">.txt</button>
                                <button id="downloadAllCsv" class="menu-btn csv">.csv (Testomat)</button>
                            </div>
                        </div>
                    </div>

                    <!-- нижняя строка: Copy | Refresh остаются как есть -->
                    <button id="copyBtnPer" class="btn-primary">Copy to clipboard</button>
                    <button id="refreshBtnPer" class="btn-muted">Refresh</button>
                </div>
            </section>
        </main>

        <!-- CSV Testomat modal -->
        <div id="csvModal" class="qc-modal hidden" role="dialog" aria-modal="true" aria-labelledby="csvModalTitle">
            <div class="qc-modal__backdrop"></div>
            <div class="qc-modal__card card">
                <h3 id="csvModalTitle" style="margin:0 0 10px;">Download CSV (for Testomat)</h3>

                <!-- отключаем нативные тултипы браузера -->
                <form id="csvForm" novalidate>
                    <label for="csvSquad" class="label">Squad:</label>
                    <select id="csvSquad" required>
                        <!-- placeholder виден в закрытом селекте, но скрыт в выпадающем списке -->
                        <option value="" selected disabled hidden>Select a Squad</option>
                        <option value="SQ1">SQ1</option>
                        <option value="SQ2">SQ2</option>
                        <option value="SQ3">SQ3</option>
                        <option value="SQ4">SQ4</option>
                        <option value="SQ5">SQ5</option>
                        <option value="SQ6">SQ6</option>
                        <option value="SQ7">SQ7</option>
                        <option value="SQ8">SQ8</option>
                        <option value="SQ9">SQ9</option>
                        <option value="SQ10">SQ10</option>
                        <option value="SQ Core">SQ Core</option>
                    </select>
                    <div id="csvSquadError" class="field-error" aria-live="polite"></div>

                    <label for="csvFolder" class="label">Test suite name (optional)</label>
                    <input id="csvFolder" type="text" placeholder="e.g., Feature name">

                    <div class="row csv-actions">
                        <button type="button" id="csvCancel" class="btn-muted">Cancel</button>
                        <button type="submit" id="csvSubmit" class="btn-primary">Download CSV</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- Column mapping modal (when headers are non-standard) -->
        <div id="colMapModal" class="qc-modal hidden" role="dialog" aria-modal="true" aria-labelledby="colMapTitle">
            <div class="qc-modal__backdrop"></div>
            <div class="qc-modal__card card colmap-card">
                <h3 id="colMapTitle" style="margin:0 0 10px;">Field Detecting</h3>

                <div class="muted small" style="margin-bottom:10px;">
                    We couldn't detect the <strong>Event</strong> and/or <strong>Property</strong> columns by header
                    name.<br>
                    Please confirm field names for events and properties.
                </div>



                <form id="colMapForm" novalidate>
                    <label for="colMapEvent" class="label">Event column header</label>
                    <input id="colMapEvent" type="text" placeholder="e.g., Event Name" list="colMapHeaderList" required>
                    <div id="colMapEventError" class="field-error" aria-live="polite"></div>

                    <label for="colMapProp" class="label">Property column header</label>
                    <input id="colMapProp" type="text" placeholder="e.g., Reported Columns" list="colMapHeaderList"
                        required>
                    <div id="colMapPropError" class="field-error" aria-live="polite"></div>

                    <datalist id="colMapHeaderList"></datalist>

                    <div class="row csv-actions" style="margin-top:12px;">
                        <button type="button" id="colMapCancel" class="btn-muted">Cancel</button>
                        <button type="submit" id="colMapApply" class="btn-primary">Apply</button>
                    </div>
                </form>

                <div class="colmap-headers" style="margin-bottom:12px; margin-top:12px;">
                    <div class="label" style="margin:0 0 6px;">Detected headers</div>
                    <div id="colMapHeaders" class="colmap-chips"></div>
                </div>
            </div>
        </div>


    </div>
</section>